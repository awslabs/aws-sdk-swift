//
// Copyright Amazon.com Inc. or its affiliates.
// All Rights Reserved.
//
// SPDX-License-Identifier: Apache-2.0
//

// Code generated by smithy-swift-codegen. DO NOT EDIT!

import Foundation
import enum AWSSDKIdentity.AWSCredentialIdentityResolverError
import enum AWSSDKIdentity.IdentityProvidingSTSClientError
import protocol AWSSDKIdentity.IdentityProvidingSTSClient
import struct AWSSDKIdentity.AWSCredentialIdentity
import struct SmithyIdentity.StaticAWSCredentialIdentityResolver

package struct IdentityProvidingSTSClient: AWSSDKIdentity.IdentityProvidingSTSClient, Swift.Sendable {
    package init() {}

    package func assumeRoleWithCreds(creds: AWSSDKIdentity.AWSCredentialIdentity, roleARN: String, roleSessionName: String, durationSeconds: Foundation.TimeInterval) async throws -> AWSSDKIdentity.AWSCredentialIdentity {
        let stsConfig = try await STSClient.STSClientConfiguration()
        stsConfig.awsCredentialIdentityResolver = SmithyIdentity.StaticAWSCredentialIdentityResolver(creds)
        let sts = STSClient(config: stsConfig)
        let out = try await sts.assumeRole(input: AssumeRoleInput(durationSeconds: Int(durationSeconds), roleArn: roleARN, roleSessionName: roleSessionName))
        guard let creds = out.credentials, let accessKey = creds.accessKeyId, let secretKey = creds.secretAccessKey else {
            throw AWSSDKIdentity.AWSCredentialIdentityResolverError.failedToResolveAWSCredentials("STSAssumeRoleAWSCredentialIdentityResolver:Failed to retrieve credentials from STS with assume role.")
        }
        return AWSCredentialIdentity(accessKey: accessKey, secret: secretKey, expiration: creds.expiration, sessionToken: creds.sessionToken)
    }

    package func getCredentialsWithWebIdentity(region: String, roleARN: String, roleSessionName: String, webIdentityToken: String) async throws -> AWSSDKIdentity.AWSCredentialIdentity {
        let sts = try STSClient(region: region)
        var out: AssumeRoleWithWebIdentityOutput
        do {
            out = try await sts.assumeRoleWithWebIdentity(input: AssumeRoleWithWebIdentityInput(
                roleArn: roleARN, roleSessionName: roleSessionName, webIdentityToken: webIdentityToken
            ))
        } catch is ExpiredTokenException {
            throw AWSSDKIdentity.IdentityProvidingSTSClientError.expiredTokenException
        } catch is IDPCommunicationErrorException {
            throw AWSSDKIdentity.IdentityProvidingSTSClientError.idpCommunicationErrorException
        } catch {
            throw AWSSDKIdentity.AWSCredentialIdentityResolverError.failedToResolveAWSCredentials(
                "STSWebIdentityAWSCredentialIdentityResolver: Failed to retrieve credentials from STS with web identity token."
            )
        }
        guard let creds = out.credentials, let access = creds.accessKeyId, let secret = creds.secretAccessKey else {
            throw AWSCredentialIdentityResolverError.failedToResolveAWSCredentials(
                "STSWebIdentityAWSCredentialIdentityResolver: Failed to retrieve credentials from STS with web identity token."
            )
        }
        return AWSCredentialIdentity(
            accessKey: access, secret: secret, expiration: creds.expiration, sessionToken: creds.sessionToken
        )
    }
}
