name: Model Integration
on:
  pull_request:
  workflow_dispatch:

jobs:
  model-integration:
    runs-on: ubuntu-latest
    container: swift:5.8-jammy
    env:
      AWS_SWIFT_SDK_USE_MAIN_DEPS: 1
      UPDATE_MODELS_GIT_URL: https://${{ secrets.GH_PAT_AWS_MODELS }}@github.com/aws/aws-models.git
    steps:
      - name: Dump env
        run: env | sort
      - name: Checkout aws-sdk-swift
        uses: actions/checkout@v3
      - name: Checkout smithy-swift
        uses: actions/checkout@v3
        with:
          repository: awslabs/smithy-swift
          path: smithy-swift
      - name: Move smithy-swift into place
        run: mv smithy-swift ..
      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: 1-${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            1-${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
            1-${{ runner.os }}-gradle-
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: '17'
      - name: Install OpenSSL
        run: apt-get -q update && apt-get -q install -y libssl-dev
      - name: Tools Versions
        run: ./scripts/ci_steps/log_tool_versions.sh
      - name: Update models from aws/aws-models repo
        run: |
          cd codegen/sdk-codegen/scripts
          ./updatemodels.sh
          cd ../../..
      - name: Delete previous generated code
        run: |
          rm -rf Sources/Services/*
          rm -rf Tests/Services/*
      - name: Generate models
        run: |
          ./gradlew -p codegen/sdk-codegen build
          ./gradlew -p codegen/sdk-codegen stageSdks
          ./gradlew --stop
          ./scripts/mergeModels.sh Sources/Services
      - name: Regenerate Package.swift
        run: |
          cd AWSSDKSwiftCLI
          swift run AWSSDKSwiftCLI generate-package-manifest ..
          cd ..
      - name: Build and test SDK
        run: swift test
